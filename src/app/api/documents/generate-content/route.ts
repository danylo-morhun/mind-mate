import { NextRequest, NextResponse } from 'next/server';
import { getGeminiClient } from '@/lib/ai/gemini-client';

interface GenerateContentRequest {
  title: string;
  template: string;
  description?: string;
  category?: string;
  type?: string;
  additionalContext?: string;
}

const documentTemplates = {
  lecture: {
    systemPrompt: `Ти - експерт з створення навчальних матеріалів для університету. 
    Твоє завдання - створити структуровану лекцію на основі заголовку та опису.
    
    ВИМОГИ:
    - Використовуй українську мову
    - Створи логічну структуру з розділами та підрозділами
    - Додай практичні приклади та пояснення
    - Використовуй Markdown форматування
    - Зроби контент зрозумілим для студентів
    - Додай висновки та питання для самоперевірки`,
    
    userPrompt: `Створи лекцію на тему: "{title}"
    
    Опис: {description}
    Категорія: {category}
    
    Додатковий контекст: {additionalContext}
    
    Створи структуровану лекцію з:
    1. Вступом та метою
    2. Основними розділами (мінімум 3-4)
    3. Практичними прикладами
    4. Висновками
    5. Питаннями для самоперевірки
    6. Рекомендованою літературою`
  },
  
  methodology: {
    systemPrompt: `Ти - експерт з створення методичних вказівок для університету. 
    Твоє завдання - створити детальні методичні вказівки на основі заголовку та опису.
    
    ВИМОГИ:
    - Використовуй українську мову
    - Створи стандартну структуру методички
    - Додай покрокові інструкції
    - Включи безпечні заходи та рекомендації
    - Використовуй Markdown форматування
    - Зроби інструкції зрозумілими та детальними`,
    
    userPrompt: `Створи методичні вказівки на тему: "{title}"
    
    Опис: {description}
    Категорія: {category}
    
    Додатковий контекст: {additionalContext}
    
    Створи методичні вказівки з:
    1. Метою та завданнями
    2. Необхідним обладнанням та матеріалами
    3. Покроковими інструкціями
    4. Безпечними заходами
    5. Критеріями оцінювання
    6. Рекомендаціями та порадами`
  },
  
  lab: {
    systemPrompt: `Ти - експерт з створення лабораторних робіт для університету. 
    Твоє завдання - створити детальну лабораторну роботу на основі заголовку та опису.
    
    ВИМОГИ:
    - Використовуй українську мову
    - Створи стандартну структуру лабораторної роботи
    - Додай теоретичну частину
    - Включи покрокові інструкції для експерименту
    - Додай формули та розрахунки
    - Використовуй Markdown форматування
    - Зроби роботу практичною та зрозумілою`,
    
    userPrompt: `Створи лабораторну роботу на тему: "{title}"
    
    Опис: {description}
    Категорія: {category}
    
    Додатковий контекст: {additionalContext}
    
    Створи лабораторну роботу з:
    1. Метою та завданнями
    2. Теоретичними основами
    3. Необхідним обладнанням
    4. Покроковою методикою
    5. Формулами та розрахунками
    6. Питаннями для контролю
    7. Висновками та рекомендаціями`
  },
  
  course: {
    systemPrompt: `Ти - експерт з створення курсових робіт для університету. 
    Твоє завдання - створити структуру та план курсової роботи на основі заголовку та опису.
    
    ВИМОГИ:
    - Використовуй українську мову
    - Створи детальний план курсової роботи
    - Додай теоретичну та практичну частини
    - Включи методику дослідження
    - Додай структуру з розділами та підрозділами
    - Використовуй Markdown форматування
    - Зроби план логічним та послідовним`,
    
    userPrompt: `Створи план курсової роботи на тему: "{title}"
    
    Опис: {description}
    Категорія: {category}
    
    Додатковий контекст: {additionalContext}
    
    Створи план курсової роботи з:
    1. Вступом та актуальністю теми
    2. Метою та завданнями дослідження
    3. Теоретичною частиною (розділи)
    4. Практичною частиною (методика)
    5. Результатами та висновками
    6. Списком використаної літератури
    7. Додатками та матеріалами`
  },
  
  thesis: {
    systemPrompt: `Ти - експерт з створення дипломних робіт для університету. 
    Твоє завдання - створити детальну структуру дипломної роботи на основі заголовку та опису.
    
    ВИМОГИ:
    - Використовуй українську мову
    - Створи повну структуру дипломної роботи
    - Додай всі необхідні розділи та підрозділи
    - Включи теоретичну, практичну та експериментальну частини
    - Додай методику дослідження та аналізу
    - Використовуй Markdown форматування
    - Зроби структуру професійною та науковою`,
    
    userPrompt: `Створи структуру дипломної роботи на тему: "{title}"
    
    Опис: {description}
    Категорія: {category}
    
    Додатковий контекст: {additionalContext}
    
    Створи структуру дипломної роботи з:
    1. Титульним листом та змістом
    2. Вступом та актуальністю
    3. Аналізом літератури
    4. Теоретичними основами
    5. Методикою дослідження
    6. Експериментальною частиною
    7. Результатами та обговоренням
    8. Висновками та рекомендаціями
    9. Списком використаної літератури
    10. Додатками та матеріалами`
  },
  
  'sheet-basic': {
    systemPrompt: `Ти - експерт з створення таблиць для університету. 
    Твоє завдання - створити структуру таблиці на основі заголовку та опису.
    
    КРИТИЧНО ВАЖЛИВО:
    - НЕ використовуй Markdown код блоки (ні CSV блоки, ні інші код блоки)
    - НЕ використовуй будь-яке Markdown форматування
    - Виводи ТІЛЬКИ чистий CSV формат
    - Перший рядок - це заголовки колонок (через кому)
    - Наступні рядки - це дані (через кому)
    - Кожен рядок на новому рядку
    - Використовуй українську мову
    - Створи логічну структуру з 3-5 колонками
    - Додай 5-10 рядків з даними
    - НЕ додавай пояснення, коментарі або інші тексти - тільки CSV дані`,
    
    userPrompt: `Створи таблицю на тему: "{title}"
    
    Опис: {description}
    Категорія: {category}
    
    Додатковий контекст: {additionalContext}
    
    Створи таблицю у форматі CSV:
    - Перший рядок: заголовки колонок (через кому)
    - Наступні рядки: дані (через кому)
    - Кожен рядок на новому рядку
    
    ВАЖЛИВО: Виведи ТІЛЬКИ CSV дані, без markdown блоків, без пояснень, без коментарів!
    Просто рядки CSV, один за одним.`
  },
  
  'sheet-grades': {
    systemPrompt: `Ти - експерт з створення таблиць оцінок для університету. 
    Твоє завдання - створити структуру таблиці оцінок на основі заголовку та опису.
    
    КРИТИЧНО ВАЖЛИВО:
    - НЕ використовуй Markdown код блоки (ні CSV блоки, ні інші код блоки)
    - НЕ використовуй будь-яке Markdown форматування
    - Виводи ТІЛЬКИ чистий CSV формат
    - Перший рядок - це заголовки колонок (через кому)
    - Наступні рядки - це дані про студентів (через кому)
    - Кожен рядок на новому рядку
    - Використовуй українську мову
    - Включи колонки: ПІБ, Оцінки за різні роботи, Середній бал
    - НЕ додавай пояснення, коментарі або інші тексти - тільки CSV дані`,
    
    userPrompt: `Створи таблицю оцінок на тему: "{title}"
    
    Опис: {description}
    Категорія: {category}
    
    Додатковий контекст: {additionalContext}
    
    Створи таблицю оцінок у форматі CSV:
    - Перший рядок: ПІБ, Лабораторна 1, Лабораторна 2, Контрольна, Середній бал
    - Наступні рядки: дані про студентів (мінімум 5 студентів)
    - Кожен рядок на новому рядку
    
    ВАЖЛИВО: Виведи ТІЛЬКИ CSV дані, без markdown блоків, без пояснень, без коментарів!
    Просто рядки CSV, один за одним.`
  },
  
  'sheet-schedule': {
    systemPrompt: `Ти - експерт з створення розкладів для університету. 
    Твоє завдання - створити структуру розкладу на основі заголовку та опису.
    
    КРИТИЧНО ВАЖЛИВО:
    - НЕ використовуй Markdown код блоки (ні CSV блоки, ні інші код блоки)
    - НЕ використовуй будь-яке Markdown форматування
    - Виводи ТІЛЬКИ чистий CSV формат
    - Перший рядок - це заголовки колонок (через кому)
    - Наступні рядки - це дані про заняття (через кому)
    - Кожен рядок на новому рядку
    - Використовуй українську мову
    - Включи колонки: День, Час, Предмет, Викладач, Аудиторія
    - НЕ додавай пояснення, коментарі або інші тексти - тільки CSV дані`,
    
    userPrompt: `Створи розклад на тему: "{title}"
    
    Опис: {description}
    Категорія: {category}
    
    Додатковий контекст: {additionalContext}
    
    Створи розклад у форматі CSV:
    - Перший рядок: День тижня, Час, Предмет, Викладач, Аудиторія
    - Наступні рядки: дані про заняття (мінімум 5-7 занять)
    - Кожен рядок на новому рядку
    
    ВАЖЛИВО: Виведи ТІЛЬКИ CSV дані, без markdown блоків, без пояснень, без коментарів!
    Просто рядки CSV, один за одним.`
  },
  
  'sheet-data': {
    systemPrompt: `Ти - експерт з створення таблиць даних для університету. 
    Твоє завдання - створити структуру таблиці даних на основі заголовку та опису.
    
    КРИТИЧНО ВАЖЛИВО:
    - НЕ використовуй Markdown код блоки (ні CSV блоки, ні інші код блоки)
    - НЕ використовуй будь-яке Markdown форматування
    - Виводи ТІЛЬКИ чистий CSV формат
    - Перший рядок - це заголовки колонок (через кому)
    - Наступні рядки - це дані (через кому)
    - Кожен рядок на новому рядку
    - Використовуй українську мову
    - Створи логічну структуру з відповідними колонками
    - Додай реалістичні дані для аналізу
    - НЕ додавай пояснення, коментарі або інші тексти - тільки CSV дані`,
    
    userPrompt: `Створи таблицю даних на тему: "{title}"
    
    Опис: {description}
    Категорія: {category}
    
    Додатковий контекст: {additionalContext}
    
    Створи таблицю даних у форматі CSV:
    - Перший рядок: заголовки колонок (через кому, мінімум 3-4 колонки)
    - Наступні рядки: дані (через кому, мінімум 8-10 рядків)
    - Кожен рядок на новому рядку
    - Дані повинні бути реалістичними та придатними для аналізу
    
    ВАЖЛИВО: Виведи ТІЛЬКИ CSV дані, без markdown блоків, без пояснень, без коментарів!
    Просто рядки CSV, один за одним.`
  }
};

export async function POST(request: NextRequest) {
  try {
    const body: GenerateContentRequest = await request.json();
    const { title, template, description, category, type, additionalContext } = body;

    // Валідація обов'язкових полів
    if (!title || !template) {
      return NextResponse.json(
        { error: 'Title and template are required' },
        { status: 400 }
      );
    }

    // Перевіряємо чи шаблон підтримується
    const supportedTemplates = Object.keys(documentTemplates);
    if (!supportedTemplates.includes(template)) {
      return NextResponse.json(
        { error: `Template '${template}' is not supported. Supported templates: ${supportedTemplates.join(', ')}` },
        { status: 400 }
      );
    }

    const geminiClient = getGeminiClient();
    if (!geminiClient) {
      return NextResponse.json(
        { error: 'Gemini client not available' },
        { status: 500 }
      );
    }

    const templateConfig = documentTemplates[template as keyof typeof documentTemplates];
    
    const userPrompt = templateConfig.userPrompt
      .replace('{title}', title)
      .replace('{description}', description || 'Не вказано')
      .replace('{category}', category || 'Не вказано')
      .replace('{additionalContext}', additionalContext || 'Не вказано');

    const fullPrompt = `${templateConfig.systemPrompt}\n\n${userPrompt}`;
    let generatedContent = await geminiClient.generateReply(fullPrompt);

    // Пост-обробка: видаляємо markdown форматування для таблиць
    if (template.startsWith('sheet-')) {
      // Видаляємо markdown форматування для таблиць
      generatedContent = generatedContent
        .replace(/```csv\s*/gi, '') // Початок CSV блоку
        .replace(/```\s*/g, '') // Кінець блоку
        .replace(/^#+\s*/gm, '') // Заголовки
        .replace(/\*\*(.*?)\*\*/g, '$1') // Жирний текст
        .replace(/\*(.*?)\*/g, '$1') // Курсив
        .replace(/`(.*?)`/g, '$1') // Inline code
        .replace(/^[-*+]\s+/gm, '') // Маркери списків
        .replace(/^\d+\.\s+/gm, '') // Нумеровані списки
        .replace(/^---+\s*$/gm, '') // Горизонтальні лінії
        .replace(/\[([^\]]+)\]\([^\)]+\)/g, '$1') // Посилання
        // Видаляємо рядки, які явно не є CSV (пояснення, коментарі)
        .split('\n')
        .filter(line => {
          const trimmed = line.trim();
          // Пропускаємо порожні рядки
          if (trimmed === '') return false;
          // Пропускаємо рядки, які виглядають як пояснення
          if (/^(Приклад|ВАЖЛИВО|Важливо|Примітка|Примітка:|Приклад формату|Створи таблицю|Створи|Ось|ВИМОГИ|КРИТИЧНО)/i.test(trimmed)) {
            return false;
          }
          // Залишаємо всі рядки, які містять коми (це CSV дані)
          return trimmed.includes(',');
        })
        .join('\n')
        .trim();
    }

    return NextResponse.json({
      success: true,
      content: generatedContent,
      template,
      metadata: {
        generatedAt: new Date().toISOString(),
        model: process.env.GOOGLE_AI_MODEL || 'gemini-2.5-flash',
        template,
        title,
        contentLength: generatedContent.length
      }
    });

  } catch (error) {
    console.error('Error generating document content:', error);
    
    return NextResponse.json(
      { 
        error: 'Failed to generate content',
        details: error instanceof Error ? error.message : 'Unknown error'
      },
      { status: 500 }
    );
  }
}
